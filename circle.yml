
machine:
  node:
    version: 6
  services:
    - docker

dependencies:
  cache_directories:
    - node_modules
  pre:
    # Authenticate to ECR
    - curl -O https://bootstrap.pypa.io/get-pip.py && python get-pip.py
    - pip install awscli
    - $(aws ecr get-login --no-include-email --region $AWS_REGION)
  override:
    - make node_modules

test:
  override:
    - echo todo

deployment:
  # deploy to dockerhub
  dockerhub:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker build -t segment/specs .
      - docker push segment/specs:latest

      - docker tag segment/specs:latest $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/specs:latest
      - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/specs:latest
